<!doctype html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Offline</title>
    <meta name="description" content>

    <!--
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
    <link rel="manifest" href="/images/favicon/site.webmanifest">
    <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-config" content="/images/favicon/browserconfig.xml">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#ffffff">
    -->

    <!--
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:image" content="">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="">
    <meta property="twitter:title" content="">
    <meta property="twitter:description" content="">
    <meta property="twitter:image" content="">
    <meta property="twitter:creator" content="@danwebbbb">
    -->

    <link rel="stylesheet" href="/styles/base.css">
  </head>
  <body>
    <main>
      
<a href="/">&#x2190; Back to all articles</a>

<h1>A basic cache implementation</h1>

<p>
  <i>Add can i use stats and links to source code</i>
</p>

<p>
  Even the most basic cache implementation can simultaneously improve performance and enable offline use of any website.
</p>
<p>
  If you haven&apos;t had the chance to play with the browser cache API this is a good place to start.
</p>

<h2>Create a service worker</h2>
<p>
  The cache API that comes with browsers was built to be used together with service workers.
</p>
<p>
  Event handlers can be utilised in service workers which allow us to hook into key life cycle events such as when the website is viewed for the first time or whenever a network request occurs.
</p>
<p>
  Creating a service worker is as simple as adding a new Javascript file to your project. We&apos;ll call it <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">service-worker.js</span><span class="token template-punctuation string">`</span></span></code> but it can be called anything.
</p>
<p>
  Then add the following to your HTML to register the <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">service-worker.js</span><span class="token template-punctuation string">`</span></span></code> file as a service worker whenever the page loads.
</p>
<pre class="language-js">
  <code class="language-js">
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&apos;serviceWorker&apos;</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&apos;load&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&apos;/service-worker.js&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </code>
</pre>
<p>
  If you reload the page, open dev tools and navigate to the application tab you should now see the service worker gets registered.
</p>
<img src="/assets/a-basic-cache-implementation/service-worker-registered.png" alt="Service worker registered">
<div style="margin-top:1em;padding:1em;background:#f3f3f3;">
  <strong>Remember:</strong> Service workers require a <a href="https://w3c.github.io/webappsec-secure-contexts/" target="_blank" rel="noopener noreferrer">secure context</a>, make sure view the page over HTTPS or localhost.
</div>

<h2>Add to the cache</h2>
<img src="/assets/a-basic-cache-implementation/basic-cache-example.png" alt="A basic cache example">
<p>
  Now, code can be added to the <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">service-worker.js</span><span class="token template-punctuation string">`</span></span></code> to create the cache.
</p>
<p>
  The service workers &quot;install&quot; event can be used to initiate the cache, it&apos;ll be called once per service worker installation. Here&apos;s what the install event handler looks like...
</p>
<pre class="language-js">
  <code class="language-js">
    self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&apos;install&apos;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </code>
</pre>
<p>
  This basic cache will contain the html, css and image used in the example webpage above. Adding these items to the cache can be achieved using <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cache.addAll</span><span class="token template-punctuation string">`</span></span></code> like so...
</p>
<pre class="language-js">
  <code class="language-js">
    self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&apos;install&apos;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token string">&apos;https://images.unsplash.com/photo-1572627690516-b531677b926f?ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=802&amp;q=80&apos;</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> thingsToCache <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;index.html&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;styles.css&apos;</span><span class="token punctuation">,</span> image<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cached <span class="token operator">=</span> caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&apos;cache&apos;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>thingsToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </code>
</pre>
<p>
  This will <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">open</span><span class="token template-punctuation string">`</span></span></code> a cache called &quot;cache&quot; and <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">addAll</span><span class="token template-punctuation string">`</span></span></code> the paths it will need to fetch then store.  
</p>
<p>
  In this case <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">event.waitUntil</span><span class="token template-punctuation string">`</span></span></code> will hold our service worker in the &quot;installing&quot; phase until it has finished caching. If this fails the service worker won&apos;t install and will be discarded instead.
</p>
<p>
  The dependant files and URLs are now in the cache, but loading this page offline will still use the network and the assets won&apos;t load. An extra step is needed to tell the browser when to use the cache.
</p>

<h2>Use the cache</h2>
<p>
  In the short intro to service workers above the super power of being able to watch &quot;whenever a network request occurs&quot; is mentioned, this is the key to replacing network requests with the contents of the cache.
</p>
<pre class="language-js">
  <code class="language-js">
    self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&apos;fetch&apos;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </code>
</pre>
<p>
  The service workers &quot;fetch&quot; event can be used to hijack any network requests. This can be used to serve a response from the cache instead of from the network...
</p>
<pre class="language-js">
  <code class="language-js">
    self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&apos;fetch&apos;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> response <span class="token operator">=</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cachedResponse</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> cachedResponse <span class="token operator">?</span> cachedResponse <span class="token punctuation">:</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </code>
</pre>
<p>
  <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">caches.match</span><span class="token template-punctuation string">`</span></span></code> will identify if there&apos;s any matching items in the cache for the current request. When there is the <code class="language-js"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">response</span><span class="token template-punctuation string">`</span></span></code> will discard the network request entirely, using the cache as priority instead.
</p>
<p>
  After a successful install a connection will no longer be required to view the page. All the dependant items will be served from the cache instead.
</p>
<h2>Next steps</h2>
<p>
  As exciting as this is, the cache implementation still needs a lot of work, it&apos;s flaws are revealed as soon as the content updates where it will continue to serve the cached content.
</p>
<p>
  Realistically a full caching strategy taking into account the content and life-cycle of production software needs to be taken into account. 
</p>
<p>
  This goes beyond a basic cache implementation, the network needs to <i>enhance</i> the stale contents of the cache to build off this implementation. 
</p>

    </main>
  </body>
</html>